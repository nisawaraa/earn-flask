{% extends "base.html" %}
{% block title %}EARN{% endblock %}

{% block content %}
<div class="container-fluid py-4" style="background:#f8f9fa;min-height:100vh;">

  <!-- Header -->
  <div class="text-center mb-5">
    <h1 class="fw-bold text-danger">ü¶ü ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡πÑ‡∏Ç‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏≠‡∏Å</h1>
    <p class="text-muted">‡∏Å‡∏≤‡∏£‡∏û‡∏±‡∏í‡∏ô‡∏≤‡πÅ‡∏ö‡∏ö‡∏à‡∏≥‡∏•‡∏≠‡∏á‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ‡∏Ç‡∏≠‡∏á‡πÄ‡∏Ñ‡∏£‡∏∑‡πà‡∏≠‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡πÑ‡∏Ç‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏≠‡∏Å‡πÉ‡∏ô‡∏à‡∏±‡∏á‡∏´‡∏ß‡∏±‡∏î‡∏û‡∏∞‡πÄ‡∏¢‡∏≤</p>
  </div>

  <!-- Summary Card -->
  <div class="row g-4 mb-4 justify-content-center">
    <div class="col-md-4">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body text-center">
          <h6 class="text-muted">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h6>
          <p class="display-5 fw-bold text-danger">{{ latest_cases }}</p>
          <p>
            {% if trend_up %}
              <span class="badge bg-danger">‚ñ≤ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô {{ diff }}</span>
            {% else %}
              <span class="badge bg-success">‚ñº ‡∏•‡∏î‡∏•‡∏á {{ diff|abs }}</span>
            {% endif %}
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Dropdown -->
  <div class="text-center mb-4">
    <div class="dropdown">
      <button class="btn btn-outline-primary dropdown-toggle" type="button" id="forecastDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ä‡πà‡∏ß‡∏á‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå: <span id="forecastLabel">12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</span>
      </button>
      <ul class="dropdown-menu" aria-labelledby="forecastDropdown">
        <li><a class="dropdown-item forecast-option" data-steps="1" href="#">1 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</a></li>
        <li><a class="dropdown-item forecast-option" data-steps="3" href="#">3 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</a></li>
        <li><a class="dropdown-item forecast-option" data-steps="6" href="#">6 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</a></li>
        <li><a class="dropdown-item forecast-option" data-steps="12" href="#">12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</a></li>
      </ul>
    </div>
  </div>

  <!-- Chart -->
  <div class="card shadow-sm border-0 mb-5">
    <div class="card-body">
      <h6 class="fw-bold text-secondary">üìà ‡πÅ‡∏ô‡∏ß‡πÇ‡∏ô‡πâ‡∏°‡∏¢‡πâ‡∏≠‡∏ô‡∏´‡∏•‡∏±‡∏á 12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô + ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢ (XGBoost)</h6>
      <div style="height:420px;">
        <canvas id="forecastChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Forecast Table + Note -->
  <div class="row g-4">
    <div class="col-md-6">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h6 class="fw-bold text-primary">üîµ XGBoost: ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢</h6>
          <table class="table table-striped table-hover table-sm" id="tbl-xgb">
            <thead class="table-light">
              <tr><th>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th><th>‡∏à‡∏≥‡∏ô‡∏ß‡∏ô (‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå)</th></tr>
            </thead>
            <tbody></tbody>
          </table>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card shadow-sm border-0">
        <div class="card-body">
          <h6 class="fw-bold">‚ÑπÔ∏è ‡∏´‡∏°‡∏≤‡∏¢‡πÄ‡∏´‡∏ï‡∏∏</h6>
          <ul class="mb-0">
            <li>‡πÄ‡∏™‡πâ‡∏ô‡∏™‡∏µ‡∏î‡∏≥ = ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏à‡∏£‡∏¥‡∏á 12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</li>
            <li>‡πÄ‡∏™‡πâ‡∏ô‡∏™‡∏µ‡∏ô‡πâ‡∏≥‡πÄ‡∏á‡∏¥‡∏ô = ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢ XGBoost</li>
          </ul>
        </div>
      </div>
    </div>
  </div>

  <!-- Links -->
  <div class="text-center mt-5">
    <a href="/yearly" class="btn btn-outline-dark me-2">üìÖ ‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ</a>
    <a href="/phayao" class="btn btn-outline-success">üó∫Ô∏è ‡πÄ‡∏à‡∏≤‡∏∞‡∏•‡∏∂‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡∏à.‡∏û‡∏∞‡πÄ‡∏¢‡∏≤ (‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà)</a>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  const historyLabels = {{ history_labels|tojson }};
  const historyValues = {{ history_values|tojson }};
  const ctx = document.getElementById('forecastChart').getContext('2d');

  // ‚úÖ Gradient ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏™‡πâ‡∏ô‡∏û‡∏¢‡∏≤‡∏Å‡∏£‡∏ì‡πå
  const gradient = ctx.createLinearGradient(0, 0, 0, 400);
  gradient.addColorStop(0, 'rgba(0,123,255,0.6)');
  gradient.addColorStop(1, 'rgba(0,123,255,0)');

  let chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: historyLabels.slice(),
      datasets: [
        {
          label: '‡∏à‡∏£‡∏¥‡∏á (12 ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î)',
          data: historyValues.slice(),
          borderColor: '#000',
          backgroundColor: '#000',
          borderWidth: 2,
          pointRadius: 4,
          pointBackgroundColor: '#000',
          pointHoverRadius: 6,
        },
        {
          label: 'XGBoost forecast',
          data: [],
          borderColor: '#007bff',
          backgroundColor: gradient,
          borderDash: [6,4],
          borderWidth: 2,
          pointRadius: 5,
          pointBackgroundColor: '#007bff',
          pointHoverRadius: 7,
          fill: true,
          tension: 0.35
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      animation: {
        duration: 1200,  // ‚úÖ ‡πÄ‡∏ß‡∏•‡∏≤ animation
        easing: 'easeOutQuart' // ‚úÖ ‡∏™‡πÑ‡∏ï‡∏•‡πå animation
      },
      plugins: {
        legend: { position: 'bottom' },
        tooltip: {
          backgroundColor: 'rgba(0,0,0,0.7)',
          titleFont: { weight: 'bold' },
          callbacks: {
            label: (ctx) => `${ctx.formattedValue} ‡∏Ñ‡∏ô`
          }
        }
      },
      scales: {
        x: { grid: { color: 'rgba(200,200,200,0.2)' } },
        y: { beginAtZero: true, grid: { color: 'rgba(200,200,200,0.2)' } }
      }
    }
  });

  function renderTable(rows) {
    const tbody = document.querySelector('#tbl-xgb tbody');
    tbody.innerHTML = '';
    rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.date}</td><td>${r.prediction}</td>`;
      tbody.appendChild(tr);
    });
  }

  async function loadForecast(steps=12) {
    const res = await fetch(`/api/forecast?steps=${steps}`);
    const data = await res.json();

    const xgb = data.xgb;
    const newLabels = historyLabels.slice();
    xgb.forEach(f => newLabels.push(f.date));

    const real = historyValues.slice();
    const lastReal = real[real.length-1];

    const xgbData = new Array(real.length - 1).fill(null)
                      .concat([lastReal])
                      .concat(xgb.map(f => f.prediction));

    chart.data.labels = newLabels;
    chart.data.datasets[0].data = real;
    chart.data.datasets[1].data = xgbData;
    chart.update();

    renderTable(xgb);

    document.getElementById('forecastLabel').innerText = steps + " ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô";
  }

  document.querySelectorAll('.forecast-option').forEach(opt => {
    opt.addEventListener('click', (e) => {
      e.preventDefault();
      loadForecast(parseInt(opt.dataset.steps));
    });
  });

  loadForecast(12);
</script>

{% endblock %}
