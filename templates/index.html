{% extends "base.html" %}
{% block title %}EARN Dashboard{% endblock %}

{% block content %}
<div class="container-fluid py-4" style="background:#f8f9fa;min-height:100vh;">

  <!-- Header -->
  <div class="text-center mb-5">
    <h1 class="fw-bold text-danger">ü¶ü ‡∏ó‡∏≥‡∏ô‡∏≤‡∏¢‡πÑ‡∏Ç‡πâ‡πÄ‡∏•‡∏∑‡∏≠‡∏î‡∏≠‡∏≠‡∏Å (‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á)</h1>
    <p class="text-muted">‡πÄ‡∏õ‡∏£‡∏µ‡∏¢‡∏ö‡πÄ‡∏ó‡∏µ‡∏¢‡∏ö "‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á" ‡∏Å‡∏±‡∏ö "XGBoost (‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå)" ‡∏£‡∏≤‡∏¢‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏Ç‡∏≠‡∏á‡∏õ‡∏µ‡∏ó‡∏µ‡πà‡πÄ‡∏•‡∏∑‡∏≠‡∏Å</p>
  </div>

  <!-- Summary Card -->
  <div class="row g-4 mb-4 justify-content-center">
    <div class="col-md-4">
      <div class="card shadow-sm border-0 h-100">
        <div class="card-body text-center">
          <h6 class="text-muted">‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡∏ú‡∏π‡πâ‡∏õ‡πà‡∏ß‡∏¢‡∏•‡πà‡∏≤‡∏™‡∏∏‡∏î</h6>
          <p class="display-5 fw-bold text-danger">{{ latest_cases }}</p>
          <p>
            {% if trend_up %}
              <span class="badge bg-danger">‚ñ≤ ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏Ç‡∏∂‡πâ‡∏ô {{ diff }}</span>
            {% else %}
              <span class="badge bg-success">‚ñº ‡∏•‡∏î‡∏•‡∏á {{ diff|abs }}</span>
            {% endif %}
          </p>
        </div>
      </div>
    </div>
  </div>

  <!-- Year dropdown + export -->
  <div class="d-flex justify-content-center align-items-center gap-3 mb-3">
    <div class="dropdown">
      <button class="btn btn-outline-primary dropdown-toggle" type="button" id="yearDropdown" data-bs-toggle="dropdown" aria-expanded="false">
        ‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏õ‡∏µ: <span id="yearLabel">{{ default_year }}</span>
      </button>
      <ul class="dropdown-menu">
        {% for y in years %}
          <li><a class="dropdown-item year-option" data-year="{{ y }}" href="#">{{ y }}</a></li>
        {% endfor %}
      </ul>
    </div>

    <a id="btnExport" class="btn btn-outline-secondary" href="/api/compare_csv?year={{ default_year }}">‚¨áÔ∏è ‡∏î‡∏≤‡∏ß‡∏ô‡πå‡πÇ‡∏´‡∏•‡∏î CSV</a>
  </div>

  <!-- Chart -->
  <div class="card shadow-sm border-0 mb-4">
    <div class="card-body">
      <h6 class="fw-bold text-secondary">üìà ‡∏Ñ‡πà‡∏≤‡∏à‡∏£‡∏¥‡∏á vs ‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå (‡∏õ‡∏µ <span id="yearTitle">{{ default_year }}</span>)</h6>
      <div style="height:420px;">
        <canvas id="compareChart"></canvas>
      </div>
    </div>
  </div>

  <!-- Table -->
  <div class="card shadow-sm border-0">
    <div class="card-body">
      <h6 class="fw-bold text-primary">üìã ‡∏ï‡∏≤‡∏£‡∏≤‡∏á: ‡πÄ‡∏î‡∏∑‡∏≠‡∏ô / ‡∏à‡∏£‡∏¥‡∏á / ‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå</h6>
      <table class="table table-striped table-hover table-sm" id="tbl-compare">
        <thead class="table-light">
          <tr><th>‡πÄ‡∏î‡∏∑‡∏≠‡∏ô</th><th>‡∏à‡∏£‡∏¥‡∏á</th><th>XGBoost (‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå)</th></tr>
        </thead>
        <tbody>
          {% for r in compare_data %}
            <tr><td>{{ r.date }}</td><td>{{ r.real }}</td><td>{{ r.pred }}</td></tr>
          {% endfor %}
        </tbody>
      </table>
    </div>
  </div>

  <!-- Links -->
  <div class="text-center mt-5">
    <a href="/yearly" class="btn btn-outline-dark me-2">üìÖ ‡∏î‡∏π‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏ó‡∏±‡πâ‡∏á‡∏õ‡∏µ</a>
    <a href="/phayao" class="btn btn-outline-success">üó∫Ô∏è ‡πÄ‡∏à‡∏≤‡∏∞‡∏•‡∏∂‡∏Å‡∏û‡∏∑‡πâ‡∏ô‡∏ó‡∏µ‡πà ‡∏à.‡∏û‡∏∞‡πÄ‡∏¢‡∏≤ (‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà)</a>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
  // init from server
  const initYear = {{ default_year }};
  const initRows = {{ compare_data|tojson }};

  const ctx = document.getElementById('compareChart').getContext('2d');

  function buildDatasets(rows){
    const labels = rows.map(r => r.date);
    const real   = rows.map(r => r.real);
    const pred   = rows.map(r => r.pred);

    return { labels, real, pred };
  }

  let init = buildDatasets(initRows);

  let chart = new Chart(ctx, {
    type: 'line',
    data: {
      labels: init.labels,
      datasets: [
        {
          label: '‡∏à‡∏£‡∏¥‡∏á',
          data: init.real,
          borderColor: '#000',
          backgroundColor: '#000',
          borderWidth: 2,
          pointRadius: 4,
          pointBackgroundColor: '#000',
          tension: 0.3
        },
        {
          label: 'XGBoost (‡∏Ñ‡∏≤‡∏î‡∏Å‡∏≤‡∏£‡∏ì‡πå)',
          data: init.pred,
          borderColor: '#0d6efd',
          backgroundColor: '#0d6efd',
          borderDash: [6,4],
          borderWidth: 2,
          pointRadius: 4,
          pointBackgroundColor: '#0d6efd',
          tension: 0.3
        }
      ]
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: { legend: { position: 'bottom' } },
      scales: { y: { beginAtZero: true } }
    }
  });

  function renderTable(rows) {
    const tbody = document.querySelector('#tbl-compare tbody');
    tbody.innerHTML = '';
    rows.forEach(r => {
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${r.date}</td><td>${r.real}</td><td>${r.pred}</td>`;
      tbody.appendChild(tr);
    });
  }

  async function loadYear(year) {
    const res = await fetch(`/api/compare?year=${year}`);
    const data = await res.json();

    // update chart
    chart.data.labels = data.labels;
    chart.data.datasets[0].data = data.real;
    chart.data.datasets[1].data = data.pred;
    chart.update();

    // update table + labels + export link
    renderTable(data.rows);
    document.getElementById('yearLabel').innerText = year;
    document.getElementById('yearTitle').innerText = year;
    document.getElementById('btnExport').href = `/api/compare_csv?year=${year}`;
  }

  document.querySelectorAll('.year-option').forEach(a => {
    a.addEventListener('click', (e) => {
      e.preventDefault();
      const y = parseInt(a.dataset.year);
      loadYear(y);
    });
  });
</script>
{% endblock %}
